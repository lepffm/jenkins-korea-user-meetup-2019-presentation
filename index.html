<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>various methods of Jenkins Infrastructure Management</title>

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/league.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<div class="slides">
				<section>
					<h3>various methods of</h3>
					<h2>Jenkins Infrastructure</h2><h3>Management</h3>
					<p>
						<small>by Glen</small>
					</p>
				</section>
<!-- -->
				<section>
						<h3 class="center">jenkins infrastructure?</h3>
							<h4>= master 운영에 관한 모든 것들</h4>
								<p>
								<ul>
										  <li>system configure</li>
										  <li>credential, slave, ssh server management</li>
								<li>monitoring</li>
								<li>etc</li>
								</ul>
							</p>
				</section>
				<section>
					<section class="center">
						<h2>methods</h2>
							<p>
								<ul>
										  <li>UI</li>
										  <li>base tooling<br>(Cli, Rest API, client libraries)</li>
								<li>groovy script</li>
								</ul>
							</section>
				</section>
					<section>
						<br>
							<h2>UI</h2>
							<section>
							  <p class="highlight-red">Good</p>
							  <ul>
								<li>윈도우를 왜 쓰는데!!!</li>
								<li>화면 캡쳐하고, 따라하기도 쉽고...</li>
								<li>jenkins의 약점이자 강점...</li>
							  </ul>
							</section>
							<section>
							  <p class="highlight-red">Bad</p>
							  <ul>
								<li class="fragment">꼭 내가 있어야 일이 돌아가냐!</li>
								<li class="fragment">Human Error.. 내가 해봐서 아는데, <br>꼭 한두개는 실수하더라...</li>
								<li class="fragment">멋이 안난다.</li>
							  </ul>
							</section>
				  </section>

				<section><br>
						<h2>base tooling</h2>
						<section>
						<ul>
						  <li>CLI</li>
						  <li>rest api, curl</li>
						  <li>client libraries</li>
						</ul>
					  </section>
						<section>
						  <h3>CLI</h3>
						  <ul>
							<li>급하게 쓸때는 간단하게.. </li>
							<li>은근히 많은 기능, 하지만 써보신 분 손!!!</li>
						  </ul>
						  <pre class="fragment"><code class="bash" data-trim data-noescape>java -jar jenkins-cli.jar \
  -auth @secret -s "http://jenkins.meetup:8080" list-jobs </code></pre>
						</section>
						  <section>
							  <h3>rest api</h3>
							  <ul>
								<li>very useful!! xpath is better</li>
								
							  </ul>
							  <span class="fragment">
							  <p>slave health check - 200 OR DIE
							  <pre><code  class="bash" data-trim data-noescape>curl --user $TOKEN -X POST -g \
"http://jenkins.meetup:8080/\
computer/SLAVE/api/xml?xpath=//offline[.='false']"</code></pre></p></span>
							  <span class="fragment">
								<p>Java - square의 <a href="https://square.github.io/retrofit/">Retrofit</a> 활용
								<pre><code class="java" data-trim data-noescape>public interface JenkinsRestClient {
	@POST("job/{JOB}/buildWithParameters?delay=0sec")
	Call<Void> buildWithParameters(@Path("JOB") String job, 
		@QueryMap Map<String, String> queryParams);
}</code></pre>
</p>
</span>
							  </section>
							  <section>
								<h3>client libraries</h3>
<table>
  <thead>
    <tr>
<th>language</th>
<th>github star</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/arangamani/jenkins_api_client">ruby-client</a></td><td>383</td>
</tr>
<tr>
<td><a href="https://github.com/bndr/gojenkins">golang-client</a></td><td>422</td>
</tr>
<tr>
<td><a href="https://github.com/jenkinsci/java-client-api">java-client</a></td><td>576</td>
</tr>
<tr>
<td><a href="https://github.com/pycontribs/jenkinsapi">python-client</a></td><td>631</td>
</tr>
</tbody>
</table>
								  
								  <h4 class="fragment">보시다시피 별로 인기가 없네요...</h4>
								</section>
							</section>

				<section>
						<h2>Groovy Script</h2>
						<section class="left">
						  <ul>
							  <li>java 또는 <font color="yellow">groovy</font>를 안다면<br>
							  Jenkins Javadoc 과 <a href="https://stackoverflow.com">stakcoverflow</a> 에 친숙하다면...<br>
							  가장 강력한 무기</li>
							  <li>script collections from jenkins<br>
								<ul><a href="https://github.com/jenkinsci/jenkins-scripts">https://github.com/jenkinsci/jenkins-scripts</a></ul>
							  </li>
						  </ul>
						</section>
						<section>
						  <h3 style="color:yellow;">Reporting</h3>
							<ul>
							  <li>various reports - job/build/slave counts ... </li>
							  <li>e.g. "count by root folder"</li>
							</ul>
							  <pre><code class="groovy" data-trim data-noescape>Jenkins.instance.items.grep(
  com.cloudbees.hudson.plugins.folder.Folder).each{
	println it.name + " : " + it.items.size()
}
return</code></pre>
						  </section>
						  <section>
							  <h3 style="color:yellow;">Operation</h3>
			  
								  <pre>update system message<code class="groovy" data-trim data-noescape>Jenkins.instance.systemMessage = \
'''Welcome Jenkins Korea Meetup'''</code>
create folder job<code data-trim data-noescape>import com.cloudbees.hudson.plugins.folder.Folder
def j = Jenkins.instance
def name = "folder-job-creation-example"
def folder = j.createProject(Folder.class, name)
folder.description = "made by groovy script"
<u>folder.save()</u></code></pre>
			  <h4 class="fragment"> ※ Don't forget to <font color="red">save</font> it.</font></h4>
			  </section>
					  <section>
						  <h3 style="color:yellow;">Test</h3>
							<ul>
							  <li>언제 눈으로 다 확인하겠어?</li>
							  <li>e.g. "verification of plugin version"</li>
							</ul>
							  <pre><code class="groovy" data-trim data-noescape>pluginName="Git plugin"; pluginVersion="3.9.3"

def plugin = Jenkins.instance.pluginManager.plugins.any{ 
it.active && 
it.displayName == pluginName && 
it.version == pluginVersion }

assert plugin</code></pre>
						  </section>
						  <section><h3 style="color:yellow;">자연스러운 궁금증</h3>
							
							  script console 에서만 가능한가요? 
			  
						  </section>
						  <section>
							  <h3 style="color:yellow;">Using Ansible</h3>
								<ul>
								  <li>like a curl - use uri module</li>
								</ul>
								  <pre>hello-ansible.yaml<code class="yaml" data-trim data-noescape>- uri:
	url: http://$JENKINS/scriptText
	method: POST
	body:
	script: "{{ lookup('file','hello.groovy') }}"
	body_format: form-urlencoded</code>
hello.groovy<code data-trim data-noescape>print 'hello ' + Jenkins.instance.systemMessage</code></pre>
							  </section>
							  </section>

				<section>
						<h2>Next... </h2>
						<section>
							<h3><img style="max-width:50%;" width="80" src="https://raw.githubusercontent.com/jenkinsci/configuration-as-code-plugin/master/plugin/src/main/webapp/img/logo-head.svg?sanitize=true"/></h3>
							<ul><li><a href="https://github.com/jenkinsci/configuration-as-code-plugin">configuration-as-code-plugin</a></li>
							<li>Yaml format</li>
							<li>exporting configurations</li>
							<li>handling secrets ( with env, vault, k8s secrets...)</li>
						  </section>
						  <section>
							  <h4>but..</h4>
							  <ul>
							  <li>some <font color="red">conflict</font> in name resolution</li>
							  <li>plugin installation is <font color="red">out of scope</font></li>
							  
							</ul>
							<br><br>
							<h5 class="fragment">... stay tuned</h5>
						  </section>
							</section>
				<section>
						<h1 style="color:yellow;">Bonus Time</h1>
				</section>
				<section>
						<h2>Bonus Time</h2>
						<section><h4 style="color:yellow;">create jenkins jnlp slave<br>with ansible</h4>
						<ul><li>create node - master</li>
						<li>create slave directory - slave</li>
						<li>download slave.jar - slave</li>
						<li>generate startup script - slave</li>
						<li>launch jnlp slave - slave</li>
						</ul>
						</section>
						  <section><h4 style="color:yellow;">groovy script</h4>
							<pre><code class="groovy">import hudson.model.*
import jenkins.model.*
import hudson.slaves.*
import hudson.slaves.EnvironmentVariablesNodeProperty.Entry
def slave = new hudson.slaves.DumbSlave(
  "{{slave_name}}", "auto generated",
  "{{slave_home}}", "1", Node.Mode.EXCLUSIVE, "TEST NEW",
  new hudson.slaves.JNLPLauncher(null, null, null),
  new hudson.slaves.RetentionStrategy.Always(),
  new LinkedList()
)
Jenkins.instance.addNode(slave)
if(slave){ print slave.computer.jnlpMac }</code></pre>
						  </section>
						  <section><h4 style="color:yellow;">ansible playbook 1/3</h4>
						  <pre><code class="yaml" data-line-numbers="6,10,14">- template: #create groovy script from template
  src: "create_jnlp_slave.groovy.j2"
  dest: "create_jnlp_slave.groovy"

- uri: #make jenkins slave
    url: "{{jenkins_url}}/scriptText"
    return_content: yes
    method: POST
    body:
	  script: "{{lookup('file','create_jnlp_slave.groovy')}}"
    body_format: form-urlencoded
    register: result
- set_fact:
	secret: "{{result.content}}"</code></pre>
					</section>
					<section><h4 style="color:yellow;">ansible playbook 2/3</h4>
					<pre><code class="yaml" data-line-numbers="6,10">- file: #create directory
	path: "{{slave_home}}"
	state: directory

- get_url: #download agent.jar from master
	url: "{{jenkins_url}}/jnlpJars/agent.jar"
	dest: "{{slave_home}}"

- name: save file to secret
	shell: echo {{secret}} >> {{slave_home}}/secret-file
	args:
	executable: /bin/bash</code></pre></section>

			<section><h4 style="color:yellow;">ansible playbook 3/3</h4>
			  <pre><code class="yaml" data-line-numbers="2-4,10">- shell: | #create run script
  echo nohup java -jar agent.jar -jnlpUrl \
    {{jenkins_url}}/computer/{{slave_name}}/slave-agent.jnlp \
    -secret {{secret}} \>\> slave.log 2\>\&1 \& > \
    {{slave_home}}/slave-start.sh
  chmod u+x {{slave_home}}/slave-start.sh
  args:
  chdir: "{{slave_home}}"
  executable: /bin/bash
- shell: "{{slave_home}}/slave-start.sh" #run script
  args:
  chdir: "{{slave_home}}"
  executable: /bin/bash
  async: 45
  poll: 0</code></pre></section>
						</section>
						<section>
								<h1>Thank you</h1>
								<a href="https://github.com/lepffm/jenkins-korea-user-meetup-2019">https://github.com/lepffm/jenkins-korea-user-meetup-2019</a>
							  </section>
					  
<!-- -->
			</div>

		</div>

		<script src="js/reveal.js"></script>

		<script>
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,
				transition: 'convex', // none/fade/slide/convex/concave/zoom
				dependencies: [
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true },
					{ src: 'plugin/search/search.js', async: true },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
